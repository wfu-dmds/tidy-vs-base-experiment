```{r load-pkgs, include = FALSE}
library(learnr)
library(rdrop2)
library(glue)
library(shinysurveys)
library(shinyalert)
library(palmerpenguins)
library(tidyverse)
library(nycflights13)
library(rlang)

knitr::opts_chunk$set(echo = FALSE)
```

```{r no-nas, echo = FALSE}
penguins_no_nas <- penguins %>%
  drop_na()
```

```{r setup, include = FALSE}
rdrop2::drop_auth(rdstoken = "token.rds")
```


```{r assessment, echo = FALSE, context = "server"}

access_username <- reactive({
  glue("{round(runif(1, 0, 100000))}_{Sys.time()}")
})

save_assessment <- function(username) {
  
  input <- getDefaultReactiveDomain()$input
  
  assess_response <- tibble::tibble(
    group = "base",
    username = username,
    nervous_pre = input[["nervous-pre"]] %||% NA_character_,
    nervous_post = input[["nervous-post"]] %||% NA_character_,
    q1 = input[["q1"]] %||% NA_real_,
    q2 = input[["q2"]] %||% NA_real_,
    q3 = input[["q3"]] %||% NA_real_,
    age = input[["age"]] %||% NA_real_,
    gender = input[["gender"]] %||% NA_character_,
    self_describe_gender = input[["self_describe_gender"]] %||% NA_character_,
    education_attained = input[["education_attained"]] %||% NA_character_,
    first_language = input[["first_language"]] %||% NA_character_,
    first_language_other = input[["first_language_other"]] %||% NA_character_,
    read_language = input[["read_language"]] %||% NA_character_,
    learned_r = input[["learned_r"]] %||% NA_character_,
    years_using_r = input[["years_using_r"]] %||% NA_character_,
    learned_programming_not_r = input[["learned_programming_not_r"]] %||% NA_character_,
    years_programming_not_r = input[["years_programming_not_r"]] %||% NA_character_,
    completed_data_analysis = input[["completed_data_analysis"]] %||% NA_character_
  )
  
  saveRDS(assess_response, file = glue::glue("assessment_{username}.rds"))
  rdrop2::drop_upload(file = glue::glue("assessment_{username}.rds"),
                      path = "/D'Agostino McGowan Data Science Lab/2022/learnr_results/")
}

update_assessments <- function() {
  
  input <- getDefaultReactiveDomain()$input
  
  assessment_inputs <- shiny::reactive({
    list(input[["nervous-pre"]],
         input[["nervous-post"]],
         input[["q1"]],
         input[["q2"]],
         input[["q3"]],
         input[["age"]],
         input[["gender"]],
         input[["self_describe_gender"]],
         input[["education_attained"]],
         input[["first_language"]],
         input[["first_language_other"]],
         input[["read_language"]],
         input[["learned_r"]],
         input[["years_using_r"]],
         input[["learned_programming_not_r"]],
         input[["years_programming_not_r"]],
         input[["completed_data_analysis"]]
    )
  })
  
  shiny::observeEvent(assessment_inputs(), {
    user_id <- access_username()
    
    save_assessment(username = user_id)
  }, 
  ignoreInit = TRUE
  )
}


update_assessments()


observeEvent(input$complete_session, {
  user_id <- access_username()
  
  if (is.na(input$q1) && is.na(input$q2) && is.na(input$q3)) {
    showModal(
      modalDialog(
        "Before you finish, please return to the \"Assessment\" tab and complete the 3 question assessment",
        footer = modalButton("Ok"),
        easyClose = TRUE
      )
    ) 
  } else {
    showModal(
      modalDialog(title = "Congratulations, you finished the study!",
                  textInput("email", 
                            "If you would like to receive a $10 Amazon gift card, please provide your email.", 
                            placeholder = "email@example.com"),
                  footer = actionButton("save_email", "Save Email")
      )
    )
  } 
}, ignoreInit = TRUE)
observeEvent(input$save_email, {
  user_id <- access_username()
  contact <- tibble::tibble(
    username = user_id,
    email = input$email
  )
  saveRDS(contact, file = glue::glue("contact_{user_id}.rds"))
  rdrop2::drop_upload(file = glue::glue("contact_{user_id}.rds"),
                      path = "/D'Agostino McGowan Data Science Lab/2022/learnr_results/")
  
  removeModal()
  showModal(modalDialog("Thank you for participating! Please close your browser window now.", footer = NULL))
})
```